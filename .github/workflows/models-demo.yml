
name: AI PR Review with GitHub Models

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: write
  models: read

jobs:
  review-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Install GitHub CLI so we can call `gh pr diff`
      - name: Install GitHub CLI
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y gh
          gh --version

      - name: Get PR diff (via GitHub CLI)
        id: diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          PR_NUMBER="$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")"

          # Fetch unified patch diff robustly (works for forks/shallow checkouts)
          gh pr diff "$PR_NUMBER" --patch > pr.diff

          # Expose PR number to later steps
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Call GitHub Model for Review
        id: ai-review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROMPT=$(jq -Rs '.' pr.diff)
          RESPONSE=$(curl -s "https://models.github.ai/inference/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -d "{
              \"model\": \"openai/gpt-4o-mini\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"You are a senior code reviewer. Provide concise, actionable feedback.\"},
                {\"role\": \"user\", \"content\": \"Review this PR diff and suggest improvements:\\n$PROMPT\"}
              ]
            }" | jq -r '.choices[0].message.content')
          echo "$RESPONSE" > review.md

      - name: Post AI Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('review.md', 'utf8');
            const prNumber = parseInt('${{ steps.diff.outputs.pr_number }}', 10);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `### ðŸ¤– AI Review\n\n${body}`
            });
