
name: AI PR Review (GitHub Models + gh)

on:
  pull_request:
    types: [opened, synchronize, reopened]

  models: read              # call GitHub Modelspermissions:

jobs:
  ai-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        # Official action to ensure gh is available in the runner
        uses: cli/cli-action@v2

      - name: Collect PR context and diff via gh
        id: diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          # Pull request metadata from the event
          PR_NUMBER="$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")"
          PR_TITLE="$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")"
          PR_AUTHOR="$(jq -r '.pull_request.user.login' "$GITHUB_EVENT_PATH")"
          BASE_REF="$(jq -r '.pull_request.base.ref' "$GITHUB_EVENT_PATH")"
          HEAD_REF="$(jq -r '.pull_request.head.ref' "$GITHUB_EVENT_PATH")"

          echo "PR #$PR_NUMBER: $PR_TITLE by $PR_AUTHOR ($HEAD_REF -> $BASE_REF)"

          # Use GitHub CLI to fetch the diff directly (handles forks/shallow clones)
          # --patch produces a unified diff; you can switch to --color=never for colorless text
          gh pr diff "$PR_NUMBER" --patch > pr.diff

          # Provide a compact summary for the prompt
          {
            echo "PR Number: #$PR_NUMBER"
            echo "PR Title: $PR_TITLE"
            echo "Author: $PR_AUTHOR"
            echo "Base Branch: $BASE_REF"
            echo "Head Branch: $HEAD_REF"
          } > pr_summary.txt

          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Trim diff if too large
        id: trim
        shell: bash
        run: |
          set -euo pipefail
          MAX_CHARS=120000 # adjust to taste. GitHub Models accept large inputs but keep it sane.

          DIFF_SIZE="$(wc -c < pr.diff)"
          if [ "$DIFF_SIZE" -gt "$MAX_CHARS" ]; then
            echo "Diff size $DIFF_SIZE exceeds $MAX_CHARS; truncating for model input."
            head -c "$MAX_CHARS" pr.diff > pr.trimmed
            echo -e "\n\n[... Diff truncated for AI review due to size ...]" >> pr.trimmed
            echo "diff_file=pr.trimmed" >> "$GITHUB_OUTPUT"
          else
            echo "diff_file=pr.diff" >> "$GITHUB_OUTPUT"
          fi

      - name: Call GitHub Models (gpt-4o-mini) for review
        id: ai
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          DIFF_FILE="${{ steps.trim.outputs.diff_file }}"
          # Convert files to JSON-safe strings
          SYS_PROMPT=$(cat << 'SYS'
          You are a senior code reviewer. Provide concise, prioritized, and actionable feedback.
          Focus on:
          1) Correctness & potential bugs
          2) Security issues (injection, XSS, SSRF, secrets, unsafe deserialization)
          3) Performance pitfalls & resource usage
          4) Concurrency & reliability
          5) Maintainability (structure, naming, duplication)
          6) Tests: missing cases and coverage
          7) Documentation: comments, README, usage notes

          If the diff seems partial or truncated, explicitly state assumptions and call out risky areas needing deeper inspection. Prefer bullet points and include short code snippets for suggested fixes where relevant.
          SYS
          )
          PR_SUMMARY_JSON=$(jq -Rs '.' pr_summary.txt)
          DIFF_JSON=$(jq -Rs '.' "$DIFF_FILE")

          # Compose a single user message with context + diff
          USER_MSG=$(jq -n --arg summary "$(cat pr_summary.txt)" --arg diff "$(cat "$DIFF_FILE")" \
            '$summary + "\n\n=== Unified Diff ===\n" + $diff' | jq -Rs '.')
          
          # Call GitHub Models (no external API key; uses GITHUB_TOKEN with models:read)
          RESPONSE=$(curl -s "https://models.github.ai/inference/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -d "{
              \"model\": \"openai/gpt-4o-mini\",
              \"temperature\": 0.2,
              \"messages\": [
                {\"role\": \"system\", \"content\": $(jq -Rs <<< \"$SYS_PROMPT\")},
                {\"role\": \"user\", \"content\": $USER_MSG}
              ]
            }" | jq -r '.choices[0].message.content')

          # Fallback message if API returns nothing
          if [ -z "$RESPONSE" ] || [ "$RESPONSE" = "null" ]; then
            RESPONSE="(No response from model. Please retry or check permissions/models availability.)"
          fi

          echo "$RESPONSE" > review.md

      - name: Post review as PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('review.md', 'utf8');
            const prNumber = parseInt('${{ steps.diff.outputs.pr_number }}', 10);

            const header = "### ðŸ¤– AI Code Review (GitHub Models)\n";
            const footer = "\n---\n_Model: openai/gpt-4o-mini Â· Temperature: 0.2_";

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `${header}\n${body}\n${footer}`
            });
  contents: read            # read repo content
  pull-requests: write      # post comments
