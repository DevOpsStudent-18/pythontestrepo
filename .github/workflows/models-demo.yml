
name: AI PR Review with GitHub Models

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  models: read

jobs:
  review-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR diff
        id: diff
        run: |
          BASE_SHA=$(jq -r '.pull_request.base.sha' "$GITHUB_EVENT_PATH")
          HEAD_SHA=$(jq -r '.pull_request.head.sha' "$GITHUB_EVENT_PATH")
          git diff --unified=0 "$BASE_SHA" "$HEAD_SHA" > pr.diff
          echo "pr_number=$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")" >> $GITHUB_OUTPUT

      - name: Call GitHub Model for Review
        id: ai-review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROMPT=$(jq -Rs '.' pr.diff)
          RESPONSE=$(curl -s "https://models.github.ai/inference/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -d "{
              \"model\": \"openai/gpt-4o-mini\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"You are a senior code reviewer. Provide concise, actionable feedback.\"},
                {\"role\": \"user\", \"content\": \"Review this PR diff and suggest improvements:\n$PROMPT\"}
              ]
            }" | jq -r '.choices[0].message.content')
          echo "$RESPONSE" > review.md

      - name: Post AI Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('review.md', 'utf8');
            const prNumber = parseInt('${{ steps.diff.outputs.pr_number }}', 10);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `### ðŸ¤– AI Review\n\n${body}`
            });

